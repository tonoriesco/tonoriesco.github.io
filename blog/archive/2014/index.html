
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Tono's Blog">
      
      
      
        <link rel="canonical" href="https://tonoriesco.github.io/blog/archive/2014/">
      
      
        <link rel="prev" href="../2018/">
      
      
        <link rel="next" href="../2013/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.7">
    
    
      
        <title>2014 - Tono Riesco</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.8608ea7d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2014" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Tono Riesco" class="md-header__button md-logo" aria-label="Tono Riesco" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Tono Riesco
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2014
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Tono Riesco" class="md-nav__button md-logo" aria-label="Tono Riesco" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Tono Riesco
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hello, I'm Tono
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../gallery/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Photography
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" checked>
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2018/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2018
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    2014
    
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2013/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2013
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2012/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2012
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2011/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2011
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2010/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2010
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2009/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2009
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2008/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2008
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2007/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2007
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Categories
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/ahorro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ahorro
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2014">2014</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2014-01-13 00:00:00+00:00">January 13, 2014</time></li>
        
        
          
          <li class="md-meta__item">
            
              9 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/">Analog Sensors Reading with Raspberry Pi and Zabbix Supervisor</a></h2>
<p>This article is based in this <a href="http://www.raspberrypi-spy.co.uk/2013/10/analogue-sensors-on-the-raspberry-pi-using-an-mcp3008/">very good one</a></p>
<p>I added some comments, examples, circuits and Zabbix configuration.</p>
<blockquote>
<p><em>The main goal is having a common interface to read analog values and generate graphs, alarms, actions etc. with Zabbix.</em></p>
</blockquote>
<h2 id="analog-sensors-reading-with-raspberry-pi-as-interface"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#analog-sensors-reading-with-raspberry-pi-as-interface">Analog Sensors Reading with Raspberry Pi as Interface</a></h2>
<p>The Raspberry Pi has no built in analogue inputs which means it is a bit of a pain to use many of the available sensors. We need a A/D interface easy to configure in the RPi and the MCP3008 is the answer.</p>
<p>The MCP3008 is a 10bit 8-channel Analogue-to-digital converter (ADC). It is cheap, easy to connect and doesn’t require any additional components. It uses the SPI bus protocol which is supported by the Pi’s GPIO header.</p>
<p>This article explains how to use an MCP3008 device to provide 8 analogue inputs which you can use with a range of sensors. In the example circuit below I use a MCP3008 to read a light sensor and control/supervise the light inside Zabbix.</p>
<p><strong>The hardware:</strong></p>
<ul>
<li>Raspberry Pi</li>
<li>MCP3008 8 channel ADC</li>
<li>Light dependent resistor (LDR)</li>
<li>10 Kohm resistor</li>
<li>Breadboard</li>
<li>Some wiring</li>
</ul>
<h3 id="spi-bus"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#spi-bus">SPI Bus</a></h3>
<p>The MCP3008 read the analog value and give a 10 bits number that is transmitted by the SPI Bus. <img alt="SPI" src="/images/posts/spi.png" /></p>
<p>The Serial Peripheral Interface bus or SPI bus is a synchronous serial data link standard, that operates in full duplex mode.</p>
<p>Devices communicate in master/slave mode where the master device initiates the data frame. Multiple slave devices are allowed with individual slave select lines.</p>
<p>Sometimes SPI is called a four-wire serial bus, contrasting with three-, two-, and one-wire serial buses. SPI is often referred to as SSI (Synchronous Serial Interface).</p>
<p>To enable hardware SPI on the RPi we need to make a modification to one of the system files:</p>
<pre><code>sudo nano /etc/modprobe.d/raspi-blacklist.conf
</code></pre>
<p>Add a ‘#’ character in front of the line spi-bcm2708. Use CTRL-X, then Y, then Return to save the file and exit. Reboot using the following :</p>
<pre><code>sudo reboot
</code></pre>
<p>To check the change has worked run the following command :</p>
<pre><code>lsmod
</code></pre>
<p>You should see “spi_bcm2708″ listed in the output.</p>
<h3 id="install-python-spi-wrapper"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#install-python-spi-wrapper">Install Python SPI Wrapper</a></h3>
<p>In this project we are going to use Python and In order to read data from the SPI bus in Python we can install a library called ‘py-spidev’. To install it we first need to install ‘python-dev’ :</p>
<pre><code>sudo apt-get install python-dev
</code></pre>
<p>Then to finish we can download ‘py-spidev’ and compile it ready for use :</p>
<pre><code>mkdir py-spidev
cd py-spidev
wget https://raw.github.com/doceme/py-spidev/master/setup.py
wget https://raw.github.com/doceme/py-spidev/master/spidev\_module.c
sudo python setup.py install
</code></pre>
<h3 id="circuit"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#circuit">Circuit</a></h3>
<p>The following list shows how the MCP3008 can be connected. It requires 4 GPIO pins on the Pi P1 Header.<img alt="mcp3008" src="/images/posts/mcp3008.png" /></p>
<table>
<thead>
<tr>
<th>MCP3008</th>
<th>RPi</th>
</tr>
</thead>
<tbody>
<tr>
<td>VDD</td>
<td>3.3V</td>
</tr>
<tr>
<td>VREF</td>
<td>3.3V</td>
</tr>
<tr>
<td>AGND</td>
<td>GROUND</td>
</tr>
<tr>
<td>CLK</td>
<td>GPIO11 (P1-23)</td>
</tr>
<tr>
<td>DOUT</td>
<td>GPIO9 (P1-21)</td>
</tr>
<tr>
<td>DIN</td>
<td>GPIO10 (P1-19)</td>
</tr>
<tr>
<td>CS</td>
<td>GPIO8 (P1-24)</td>
</tr>
<tr>
<td>DGND</td>
<td>GROUND</td>
</tr>
</tbody>
</table>
<p>The CH0-CH7 pins are the 8 analogue inputs.</p>
<p>Next we can see the schematic of the circuit:</p>
<p><img alt="ssm-light_schem.png" src="/images/posts/ssm-light_schem.png" /></p>
<p>Here is the breadboard circuit :</p>
<p><img alt="SSM-Light_bb" src="/images/posts/ssm-light_bb.png" /></p>
<p>It uses CH0 for the light sensor. The other 7 inputs are spare.</p>
<p>Here is a photo of my test circuit on a small piece of breadboard:</p>
<p><img alt="SSM-Light_photo" src="/images/posts/rasberrypi-light.jpg" /></p>
<h3 id="light-dependent-resistor"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#light-dependent-resistor">Light Dependent Resistor</a></h3>
<p>I chose a <strong>LDR EG &amp; G Vactec, VT43, CdS, 8 Ω to 300 KΩ</strong>. Under normal lighting its resistance is approximately 10Kohm while in the dark this increases to over 2Mohm.<img alt="ldr_example" src="/images/posts/ldr.png" /></p>
<p>When there is lots of light the LDR has a low resistance resulting in the output voltage dropping towards 0V.</p>
<p>When it is dark the LDR resistance increases resulting in the output voltage increasing towards 3.3V. In this project has been used a LDR but whatever device changing his resistance depending of some phenomenon can be used and wired in the IC to be controlled.</p>
<h4 id="reading-the-data"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#reading-the-data">Reading The Data</a></h4>
<p>The ADC is 10bit so it can report a range of numbers from 0 to 1023 (2 to the power of 10). A reading of 0 means the input is 0V and a reading of 1023 means the input is 3.3V. Our 0-3.3V range would equate to a 0-10000 Lux range.</p>
<p>To read the data I used this Python script get_light.py:</p>
<pre><code class="language-python">#!/usr/bin/python

#!/usr/bin/python

import spidev
import time
import os

# Open SPI bus
spi = spidev.SpiDev()
spi.open(0,0)

# Function to read SPI data from MCP3008 chip
# Channel must be an integer 0-7

def ReadChannel(channel):
adc = spi.xfer2([1,(8+channel)&lt;&lt;4,0])
data = ((adc[1]&amp;3) &lt;&lt; 8) + adc[2]
return data

# Function to convert data to voltage level,
# rounded to specified number of decimal places.

def ConvertVolts(data,places):
volts = (data * 3.3) / 1023
volts = round(volts,places)
return volts

# Define sensor channels
light_channel = 0

# Define delay between readings
delay = 1

while True:
# Read the light sensor data
light_level = 1024 – ReadChannel(light_channel)
light_volts = ConvertVolts(light_level,2)

# Print out results
print “——————————————–”
print(“Light: {} ({}V)”.format(light_level,light_volts))

# Wait before repeating loop
time.sleep(delay)
</code></pre>
<p>The output with normal light is:</p>
<pre><code class="language-bash">pi@pi-access-lab ~ $ ./get_light.py
——————————————–
Light: 904 (2.92V)
——————————————–
Light: 895 (2.89V)
——————————————–
Light: 903 (2.91V)
——————————————–
Light: 895 (2.89V)
——————————————–
Light: 904 (2.92V)
——————————————–
Light: 906 (2.92V)
——————————————–
Light: 896 (2.89V)
——————————————–
Light: 887 (2.86V)
——————————————–
Light: 894 (2.88V)
——————————————–
Light: 906 (2.92V)
——————————————–
</code></pre>
<h3 id="zabbix-integration"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#zabbix-integration">ZABBIX Integration</a></h3>
<h4 id="zabbix-agent"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#zabbix-agent">Zabbix Agent</a></h4>
<p>The Zabbix Agent must be installed in the RPi in order to receive the requests from the server and send the value read. Install the agent with:</p>
<pre><code>sudo apt-get update &amp;&amp; sudo apt-get install zabbix-agent
</code></pre>
<p>The script written in Python has to be modified a bit. we want to have 100% light for the maximum light and 0% for the minimum.</p>
<blockquote>
<p>SSM Server request light to RPi → Zabbix Agent send only the percent as a number.</p>
</blockquote>
<p>Here is the python code modified:</p>
<pre><code class="language-python">#!/usr/bin/python

import spidev
import time
import os

# Open SPI bus
spi = spidev.SpiDev()
spi.open(0,0)

# Function to read SPI data from MCP3008 chip
# Channel must be an integer 0-7
def ReadChannel(channel):
adc = spi.xfer2([1,(8+channel)&lt;&lt;4,0])
data = ((adc[1]&amp;3) &lt;&lt; 8) + adc[2]
return data

# Function to convert data to voltage level,
# rounded to specified number of decimal places.
def ConvertVolts(data,places):
volts = (data * 3.3) / 1023
volts = round(volts,places)
return volts

# Define sensor channels
light_channel = 0

# Read the light sensor data
light_level = (1024 – ReadChannel(light_channel)) / 10.24
light_volts = ConvertVolts(light_level,2)

# Print out results
print(“{:.3}”.format(light_level))
</code></pre>
<p>The output with normal light is:</p>
<pre><code class="language-bash">[code language=”bash”]
pi@pi-access-lab ~ $ ./ssm_get.py
88.4
</code></pre>
<p>The zabbix_agent must be configured as usual with the Zabbix Server server etc, and add the command lines at the end of the configuration file. When the server request <strong>light</strong> the agent must know what to do. That is done editing the file:</p>
<pre><code>/etc/zabbix/zabbix\_agentd.conf
</code></pre>
<p>and adding:</p>
<pre><code class="language-bash">### Option: UserParameter

# User-defined parameter to monitor. There can be several user-defined parameters.
# Format: UserParameter=,
# Note that shell command must not return empty string or EOL only.
# See ‘zabbix_agentd’ directory for examples.
#
# Mandatory: no
# Default:

UserParameter=light,sudo /home/pi/ssm_get.py
</code></pre>
<p>Another important hack is that the user running the zabbix_agent (in my case zabbix) must have the rights to execute the command as root since we are accessing to the SPI port of the RPi. If we want to avoid writing the passwords in the scripts we can authorise the user zabbix in the sudoers file only for the command or in my case more general:</p>
<pre><code>/etc/sudoers
</code></pre>
<pre><code class="language-bash"># See sudoers(5) for more information on “#include” directives:
#includedir /etc/sudoers.d
pi ALL=(ALL) NOPASSWD: ALL
zabbix ALL=(ALL) NOPASSWD: ALL
</code></pre>
<h3 id="zabbix-server"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#zabbix-server">Zabbix Server</a></h3>
<p>To check the installation before adding the host and checks in the server we can run in the Zabbix Server:</p>
<pre><code class="language-bash">[root@server ~]# zabbix_get -s pi-access-lab -k light
87.5
</code></pre>
<p>If that works and return the value, we can add the RPi in the Zabbix Server and create an item called light or whatever we want and associate an external check:</p>
<p><img alt="zabbix_config)" src="/images/posts/zabbix-config.png" /> </p>
<p>We can create screens for the data, graphs or whatever we need. 
Refer to the Zabbix documentation to do it. The result after 2 or 3 days getting data in my desk is: </p>
<p><img alt="zabbix_result" src="/images/posts/zabbix-result.png" /></p>
<hr />
<h2 id="11-comments"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#11-comments">11 Comments</a></h2>
<h4 id="martin-on-07052014-at-1515"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#martin-on-07052014-at-1515">Martin on 07/05/2014 at 15:15:</a></h4>
<p>Is it possible to connect more than one MCP3008 + LDR to the SPI bus with this setup? And is it possible to address this SPI via USB with standaard USB-SPI converters like ‘Bus Pirate’ ?</p>
<h4 id="tono-on-07052014-at-1541"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#tono-on-07052014-at-1541">Tono on 07/05/2014 at 15:41:</a></h4>
<p>Hi Martin,  </p>
<p>Well, reading http://en.wikipedia.org/wiki/Serial_Peripheral_Interface_Bus I would say yes, you can, but look not too simple… What I would do is getting a chip with more inputs if you need more than 8 converters.
For the USB-SPI converters, honestly, I don’t know. I never used any of them.  </p>
<p>Regards.</p>
<hr />
<h4 id="andres-on-04112014-at-1455"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#andres-on-04112014-at-1455">Andres on 04/11/2014 at 14:55:</a></h4>
<p>Good information, thank’s 😉</p>
<hr />
<h4 id="danielcamargo-on-13022015-at-0119"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#danielcamargo-on-13022015-at-0119">DanielCamargo on 13/02/2015 at 01:19:</a></h4>
<p>Hello Tono, can I receive more than one parameter using “UserParameter” in the agentd.conf with the same python script. I’ld like to measure temperature, humidty, pressure and light. Can you help me with this? Thanks!</p>
<h4 id="tono-on-13022015-at-0959"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#tono-on-13022015-at-0959">Tono on 13/02/2015 at 09:59:</a></h4>
<p>Hi Daniel, I don’t know how is done your python script but my advice is that you do one python script for each parameter (temp, light, etc.) or a python script that take a command line argument. You have several and very good examples to do that here: http://www.tutorialspoint.com/python/python_command_line_arguments.htm.</p>
<p>Now, imagine you do a script that take the commands of: temp and light… The most important is that when you run in the command line of the RPi, the script return “something” exemple:</p>
<pre><code>$ script.py temp
$ 23.2

$ script.py light
$ 350
</code></pre>
<p>The script should return the temperature without anything else! Verify that doesn’t return the carrier return or other characters that could have problems with the Zabbix agent. (I had problems in the past)</p>
<p>Now, in the zabbix_agentd.conf you have to put 2 lines like this:
    UserParameter=temp,script.py temp
    UserParameter=light,script.py light</p>
<p>Later in the Zabbix interface create 2 items with the names: light and temp and is done!</p>
<p>An example from my system that is working:
In the Raspberry Pi when I run: “cat /sys/class/thermal/thermal_zone0/temp” that returns the CPU temperature. For taking this value inside Zabbix, I write in the zabbix_agentd.conf:</p>
<pre><code>UserParameter=cpu.temp,cat /sys/class/thermal/thermal_zone0/temp
</code></pre>
<p>In Zabbix, I create a Item in the Rasperry Host like this:</p>
<pre><code>Name: CPU Temperature
Type: Zabbix agent
Key: cpu.temp
Host interface: Raspberry Host
Type of information: Numeric (float)
Units: Degrees
Use custom multiplier: 0.001
</code></pre>
<p>Hope that helps.</p>
<hr />
<h4 id="danielcamargo-on-20022015-at-2216"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#danielcamargo-on-20022015-at-2216">DanielCamargo on 20/02/2015 at 22:16</a></h4>
<p>Hello Tono,</p>
<p>This is the answer that is closer to me resolve the issue. I will test and notice here. Thank you for your help.</p>
<hr />
<h4 id="danielcamargo-on-28022015-at-1848"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#danielcamargo-on-28022015-at-1848">DanielCamargo on 28/02/2015 at 18:48</a></h4>
<p>Hi Tono,</p>
<p>I managed to send multiple data using zabbix-api for Python using JSON format. The module I used was the zbxsend (github.com/pistolero/zbxsend).
Thank you for your help! It was essential for my research project.</p>
<h4 id="tono-on-28022015-at-1850"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#tono-on-28022015-at-1850">Tono on 28/02/2015 at 18:50</a></h4>
<p>Nice to know that helped.</p>
<hr />
<h4 id="chandan-bathula-on-22112016-at-1411"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#chandan-bathula-on-22112016-at-1411">Chandan Bathula on 22/11/2016 at 14:11</a></h4>
<p>Hello Tono</p>
<p>I am a student and i am new to Python and as well as Raspberry pi 3. I have a project where i have to record the data from the temperature sensor using raspberry pi 3 and mcp3008. I have to transfer these values to another pc via wifi and generate graphs of these values. Could you give me some inputs so that i could go forward with my project. Thanking you in advance.</p>
<h4 id="daniel-dos-santos-silva-on-05052017-at-1344"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#daniel-dos-santos-silva-on-05052017-at-1344">Daniel dos Santos Silva on 05/05/2017 at 13:44</a></h4>
<p>Hi Tono… Can you reupload the broken link images? Thanks.</p>
<h4 id="tono-riesco-on-05052017-at-1437"><a class="toclink" href="../../2014/01/13/analog-sensors-reading-with-raspberry-pi-and-zabbix-supervisor/#tono-riesco-on-05052017-at-1437">Tono Riesco on 05/05/2017 at 14:37</a></h4>
<p>Hi Daniel,</p>
<p>Thank you for telling me. I did it.</p>
<p>Regards.</p>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>